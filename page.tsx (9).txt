"use client"

import { useState } from "react"
import { useRouter } from "next/navigation"
import { Star, Send, ThumbsUp, MessageSquare, Calendar, Plane } from "lucide-react"
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { submitFeedback } from "@/lib/feedback"

export default function FeedbackPage() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [submitted, setSubmitted] = useState(false)
  const [rating, setRating] = useState<number | null>(null)
  const [hoverRating, setHoverRating] = useState<number | null>(null)
  const [feedbackType, setFeedbackType] = useState("flight")

  const [formData, setFormData] = useState({
    bookingReference: "",
    flightNumber: "",
    departureDate: "",
    feedbackCategory: "service",
    comments: "",
    contactEmail: "",
    allowContact: true,
  })

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target
    setFormData((prev) => ({
      ...prev,
      [name]: type === "checkbox" ? checked : value,
    }))
  }

  const handleSelectChange = (name, value) => {
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }))
  }

  const handleSubmit = async (e) => {
    e.preventDefault()

    if (!rating) {
      alert("Please provide a rating")
      return
    }

    setLoading(true)

    try {
      // Submit feedback
      await submitFeedback({
        ...formData,
        rating,
        type: feedbackType,
      })

      // Show success state
      setSubmitted(true)

      // Reset form after delay
      setTimeout(() => {
        setRating(null)
        setFormData({
          bookingReference: "",
          flightNumber: "",
          departureDate: "",
          feedbackCategory: "service",
          comments: "",
          contactEmail: "",
          allowContact: true,
        })
        setSubmitted(false)
      }, 5000)
    } catch (error) {
      console.error("Error submitting feedback:", error)
      alert("There was an error submitting your feedback. Please try again.")
    } finally {
      setLoading(false)
    }
  }

  // Categories based on feedback type
  const getCategories = () => {
    switch (feedbackType) {
      case "flight":
        return [
          { id: "service", name: "Cabin Service" },
          { id: "comfort", name: "Comfort & Amenities" },
          { id: "food", name: "Food & Beverages" },
          { id: "entertainment", name: "Entertainment" },
          { id: "timeliness", name: "Timeliness" },
        ]
      case "booking":
        return [
          { id: "website", name: "Website Experience" },
          { id: "app", name: "Mobile App" },
          { id: "payment", name: "Payment Process" },
          { id: "options", name: "Booking Options" },
          { id: "changes", name: "Changes & Cancellations" },
        ]
      case "customer-service":
        return [
          { id: "responsiveness", name: "Responsiveness" },
          { id: "knowledge", name: "Staff Knowledge" },
          { id: "resolution", name: "Problem Resolution" },
          { id: "communication", name: "Communication" },
        ]
      default:
        return [{ id: "general", name: "General" }]
    }
  }

  return (
    <div className="container max-w-3xl py-10">
      <Card className="border-2 border-gray-200 shadow-md">
        <CardHeader>
          <CardTitle className="text-primary text-center">Share Your Feedback</CardTitle>
          <CardDescription className="text-center">
            We value your opinion and are committed to improving our services
          </CardDescription>
        </CardHeader>

        {submitted ? (
          <CardContent className="text-center py-10">
            <div className="flex flex-col items-center justify-center space-y-4">
              <div className="bg-green-100 rounded-full p-3">
                <ThumbsUp className="h-8 w-8 text-green-600" />
              </div>
              <h3 className="text-xl font-medium text-primary">Thank You for Your Feedback!</h3>
              <p className="text-gray-600 max-w-md">
                Your feedback has been submitted successfully. We appreciate you taking the time to share your
                experience with us.
              </p>
              <Button className="mt-4 bg-primary hover:bg-secondary" onClick={() => router.push("/")}>
                Return to Dashboard
              </Button>
            </div>
          </CardContent>
        ) : (
          <form onSubmit={handleSubmit}>
            <CardContent className="space-y-6">
              <Tabs defaultValue="flight" onValueChange={setFeedbackType}>
                <TabsList className="grid w-full grid-cols-3">
                  <TabsTrigger value="flight" className="data-[state=active]:bg-primary data-[state=active]:text-white">
                    <Plane className="h-4 w-4 mr-2" />
                    Flight Experience
                  </TabsTrigger>
                  <TabsTrigger
                    value="booking"
                    className="data-[state=active]:bg-primary data-[state=active]:text-white"
                  >
                    <Calendar className="h-4 w-4 mr-2" />
                    Booking Process
                  </TabsTrigger>
                  <TabsTrigger
                    value="customer-service"
                    className="data-[state=active]:bg-primary data-[state=active]:text-white"
                  >
                    <MessageSquare className="h-4 w-4 mr-2" />
                    Customer Service
                  </TabsTrigger>
                </TabsList>
              </Tabs>

              <div className="space-y-2">
                <Label>Your Rating</Label>
                <div className="flex items-center gap-1">
                  {[1, 2, 3, 4, 5].map((star) => (
                    <button
                      key={star}
                      type="button"
                      className="focus:outline-none"
                      onClick={() => setRating(star)}
                      onMouseEnter={() => setHoverRating(star)}
                      onMouseLeave={() => setHoverRating(null)}
                    >
                      <Star
                        className={`h-8 w-8 ${
                          (hoverRating !== null ? star <= hoverRating : star <= (rating || 0))
                            ? "text-yellow-400 fill-yellow-400"
                            : "text-gray-300"
                        }`}
                      />
                    </button>
                  ))}
                  <span className="ml-2 text-sm text-gray-600">
                    {rating ? `${rating} out of 5 stars` : "Select a rating"}
                  </span>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="bookingReference">Booking Reference</Label>
                  <Input
                    id="bookingReference"
                    name="bookingReference"
                    placeholder="e.g. ABC123"
                    value={formData.bookingReference}
                    onChange={handleInputChange}
                    className="border-gray-200"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="flightNumber">Flight Number</Label>
                  <Input
                    id="flightNumber"
                    name="flightNumber"
                    placeholder="e.g. SK101"
                    value={formData.flightNumber}
                    onChange={handleInputChange}
                    className="border-gray-200"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="departureDate">Departure Date</Label>
                  <Input
                    id="departureDate"
                    name="departureDate"
                    type="date"
                    value={formData.departureDate}
                    onChange={handleInputChange}
                    className="border-gray-200"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="feedbackCategory">Feedback Category</Label>
                  <Select
                    value={formData.feedbackCategory}
                    onValueChange={(value) => handleSelectChange("feedbackCategory", value)}
                  >
                    <SelectTrigger id="feedbackCategory" className="border-gray-200">
                      <SelectValue placeholder="Select category" />
                    </SelectTrigger>
                    <SelectContent>
                      {getCategories().map((category) => (
                        <SelectItem key={category.id} value={category.id}>
                          {category.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="comments">Your Feedback</Label>
                <Textarea
                  id="comments"
                  name="comments"
                  placeholder="Please share your experience and any suggestions for improvement..."
                  rows={5}
                  value={formData.comments}
                  onChange={handleInputChange}
                  className="border-gray-200 resize-none"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="contactEmail">Email Address (Optional)</Label>
                <Input
                  id="contactEmail"
                  name="contactEmail"
                  type="email"
                  placeholder="your.email@example.com"
                  value={formData.contactEmail}
                  onChange={handleInputChange}
                  className="border-gray-200"
                />
                <div className="flex items-center gap-2 mt-2">
                  <input
                    type="checkbox"
                    id="allowContact"
                    name="allowContact"
                    checked={formData.allowContact}
                    onChange={handleInputChange}
                    className="rounded border-gray-300"
                  />
                  <Label htmlFor="allowContact" className="text-sm font-normal">
                    I agree to be contacted regarding my feedback if necessary
                  </Label>
                </div>
              </div>
            </CardContent>

            <CardFooter className="flex justify-end border-t pt-6">
              <Button type="submit" className="bg-primary hover:bg-secondary" disabled={loading}>
                {loading ? (
                  <>
                    <span className="animate-spin mr-2">‚ü≥</span>
                    Submitting...
                  </>
                ) : (
                  <>
                    <Send className="h-4 w-4 mr-2" />
                    Submit Feedback
                  </>
                )}
              </Button>
            </CardFooter>
          </form>
        )}
      </Card>

      <div className="mt-8 space-y-4">
        <h2 className="text-xl font-bold text-primary">Why Your Feedback Matters</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Card className="border-2 border-gray-200">
            <CardContent className="p-6 text-center">
              <div className="bg-gray-100 rounded-full p-3 inline-block mb-4">
                <ThumbsUp className="h-6 w-6 text-primary" />
              </div>
              <h3 className="font-medium mb-2">Improve Our Service</h3>
              <p className="text-sm text-gray-600">
                Your feedback helps us identify areas where we can enhance your travel experience.
              </p>
            </CardContent>
          </Card>

          <Card className="border-2 border-gray-200">
            <CardContent className="p-6 text-center">
              <div className="bg-gray-100 rounded-full p-3 inline-block mb-4">
                <MessageSquare className="h-6 w-6 text-primary" />
              </div>
              <h3 className="font-medium mb-2">We're Listening</h3>
              <p className="text-sm text-gray-600">
                Every piece of feedback is reviewed by our dedicated customer experience team.
              </p>
            </CardContent>
          </Card>

          <Card className="border-2 border-gray-200">
            <CardContent className="p-6 text-center">
              <div className="bg-gray-100 rounded-full p-3 inline-block mb-4">
                <Plane className="h-6 w-6 text-primary" />
              </div>
              <h3 className="font-medium mb-2">Better Flights</h3>
              <p className="text-sm text-gray-600">
                Your insights directly influence our service improvements and future offerings.
              </p>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  )
}

